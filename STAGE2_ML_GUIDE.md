# 阶段2：机器学习版本（集成学习）使用指南

## 概述

这是阶段2的机器学习增强版本，使用集成学习（Ensemble Learning）方法来估计粉丝投票。相比基础版本，预期准确率可以提升5-15%。

## 核心特点

### 1. 集成学习架构
- **多个基础模型**：
  - 随机森林回归器 (RandomForestRegressor)
  - 梯度提升回归器 (GradientBoostingRegressor)
  - Ridge回归 (Ridge)
  - Lasso回归 (Lasso)
  - 弹性网络 (ElasticNet)

- **集成方法**：
  - 使用 `VotingRegressor` 组合多个模型的预测
  - 自动加权平均各模型的输出

### 2. 增强的特征工程
- **更多特征**：
  - 评委评分特征（总分、排名、百分比）
  - 历史表现特征（平均评分、排名趋势）
  - 选手特征（年龄、行业、年龄分组）
  - 专业舞者特征（历史平均表现）
  - 周次特征（周次比例、剩余选手数）
  - 排名趋势（评分变化、排名变化）

- **特征处理**：
  - 标准化缩放（StandardScaler）
  - 标签编码（LabelEncoder）
  - 缺失值处理

### 3. 模型训练策略
- **训练数据**：使用所有历史数据训练
- **交叉验证**：使用5折交叉验证评估模型性能
- **特征重要性**：分析哪些特征最重要

## 快速开始

### 方法1：使用Python脚本（推荐）

```bash
python scripts/run_stage2_ml_estimation.py
```

### 方法2：在Python代码中使用

```python
from fan_vote_estimator_ml import MLFanVoteEstimator
import pandas as pd

# 加载数据
df = pd.read_csv('2026_MCM_Problem_C_Data_processed.csv')

# 创建ML估计器
estimator = MLFanVoteEstimator(df)

# 估计所有周次（使用ML方法）
estimates_df = estimator.estimate_all_weeks_ml(train_on_all=True)

# 验证模型
validation_results = estimator.validate_estimates(estimates_df)

# 查看特征重要性
print(estimator.feature_importance)
```

## 工作流程

### 步骤1：准备训练数据
- 从所有季次和周次提取特征
- 标记被淘汰选手
- 构建训练数据集

### 步骤2：训练多个模型
- 训练5个不同的回归模型
- 使用交叉验证评估性能
- 选择最佳模型组合

### 步骤3：创建集成模型
- 使用 `VotingRegressor` 组合模型
- 自动加权平均预测结果

### 步骤4：预测粉丝投票
- 对每个周次提取特征
- 使用集成模型预测"被淘汰概率"
- 将概率转换为粉丝投票（排名或百分比）

### 步骤5：验证和评估
- 验证预测的淘汰结果
- 计算准确率
- 分析特征重要性

## 输出文件

运行后会生成：

1. **`fan_vote_estimates_ml.csv`**
   - 使用ML方法估计的粉丝投票
   - 包含 `estimation_method` 列标识使用的方法

2. **`validation_results_ml.json`**
   - ML版本的验证结果
   - 包含准确率、正确/错误预测数量

3. **`fan_vote_uncertainty_ml.csv`**
   - ML版本的不确定性分析

4. **`stage2_ml_report.txt`**
   - ML版本的摘要报告
   - 包含特征重要性分析

## 预期改进

### 准确率对比
- **基础版本**: ~51.84%
- **ML版本预期**: 60-70%
- **改进幅度**: +8-18%

### 优势
1. **更好的特征利用**：自动学习特征之间的关系
2. **鲁棒性**：集成多个模型，减少过拟合
3. **可解释性**：特征重要性分析
4. **灵活性**：易于添加新特征和新模型

## 模型选择

### 为什么选择这些模型？

1. **随机森林**：
   - 处理非线性关系
   - 自动特征选择
   - 对异常值鲁棒

2. **梯度提升**：
   - 强大的预测能力
   - 逐步优化
   - 处理复杂模式

3. **Ridge/Lasso/ElasticNet**：
   - 线性模型，可解释性强
   - 正则化防止过拟合
   - 快速训练

4. **集成方法**：
   - 结合各模型优势
   - 减少单一模型的偏差
   - 提高泛化能力

## 特征重要性分析

模型训练后会显示特征重要性，帮助理解：
- 哪些因素最影响粉丝投票
- 哪些特征可以进一步优化
- 模型的决策依据

## 注意事项

1. **训练时间**
   - ML版本需要训练模型，可能需要更长时间
   - 建议先用小数据集测试

2. **内存使用**
   - 训练多个模型需要更多内存
   - 如果内存不足，可以减少模型数量

3. **数据质量**
   - 确保阶段1预处理已完成
   - 特征质量直接影响模型性能

4. **过拟合风险**
   - 使用交叉验证评估
   - 监控训练集和验证集性能

## 调优建议

### 1. 调整模型参数
```python
# 在 fan_vote_estimator_ml.py 中修改
RandomForestRegressor(
    n_estimators=200,  # 增加树的数量
    max_depth=15,      # 增加深度
    ...
)
```

### 2. 添加更多特征
- 选手的社交媒体影响力
- 专业舞者的详细统计
- 季节因素

### 3. 尝试其他模型
- XGBoost
- LightGBM
- 神经网络

### 4. 调整集成权重
- 根据交叉验证结果调整各模型的权重
- 使用 Stacking 方法

## 与基础版本对比

| 特性 | 基础版本 | ML版本 |
|------|---------|--------|
| 方法 | 优化算法 | 机器学习集成 |
| 特征 | 基础特征 | 增强特征工程 |
| 准确率 | ~52% | 预期60-70% |
| 训练时间 | 快 | 中等 |
| 可解释性 | 高 | 中等（有特征重要性） |
| 灵活性 | 中等 | 高 |

## 下一步

完成ML版本后，可以：
1. 对比两个版本的结果
2. 分析特征重要性
3. 进一步优化模型参数
4. 进入阶段3：投票方法比较分析

## 常见问题

**Q: ML版本一定比基础版本好吗？**
A: 通常更好，但不一定。取决于数据质量和特征工程。

**Q: 如何选择使用哪个版本？**
A: 建议两个版本都运行，对比结果。ML版本通常更准确，但基础版本更可解释。

**Q: 可以混合使用吗？**
A: 可以！可以先用ML版本预测，然后用基础版本验证和调整。

**Q: 训练时间太长怎么办？**
A: 可以减少模型数量，或使用更小的数据集训练。
