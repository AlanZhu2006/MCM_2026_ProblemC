# 状态空间模型方法指南

## 背景：借鉴2024年MCM C题

2024年MCM C题《网球运动中的动量（Momentum in Tennis）》与2026年"粉丝投票推导"问题高度相关。该题目要求根据温布尔登网球赛的得分记录，量化球员在比赛过程中的"动量"——这是一个典型的不可直接观测的隐藏变量。

### 优秀论文的方法（Team 2410482）

1. **状态空间模型（State Space Model）**
   - 将动量建模为随时间演化的隐状态
   - 球员的得分、非受迫性失误及跑动距离被视为观测变量

2. **卡尔曼滤波（Kalman Filter）**
   - 通过预测和更新步骤，实时推断当前时刻动量的概率分布
   - 提供不确定性量化（协方差矩阵）

3. **马尔可夫模型（Markov Model）**
   - 计算在特定动量状态下的获胜概率
   - 通过逻辑回归验证动量对比赛流向的显著性影响

### 优秀论文的方法（Team 2301192）

1. **MCMC贝叶斯层级模型**
   - 定义先验输入（如信息熵、使用频率）
   - 使用XGBoost回归模型预测结果分布

2. **ARIMA模型**
   - 捕捉周期性波动
   - 处理时间序列上的热度更迭

3. **聚类+分类组合**
   - K-means聚类与决策树结合
   - 量化抽象变量（如"难度"）为逻辑层级

## 应用到粉丝投票估计问题

### 核心思想

1. **粉丝投票是隐变量**
   - 不可直接观测（数据保密）
   - 需要通过观测变量推断

2. **观测变量**
   - 评委评分（已知）
   - 历史表现（已知）
   - 综合排名/百分比（部分已知）

3. **时间序列特性**
   - 每周的粉丝投票会动态变化
   - 有惯性（与上周相关）
   - 受评委评分影响

### 状态空间模型

#### 状态方程（State Equation）

```
fan_vote[t] = A * fan_vote[t-1] + B * judge_score[t] + w[t]
```

其中：
- `fan_vote[t]`: 隐状态（粉丝投票）
- `A`: 自回归系数（惯性，如0.7表示70%的惯性）
- `judge_score[t]`: 已知输入（评委评分）
- `B`: 输入系数（评委评分的影响，如0.2）
- `w[t]`: 过程噪声（粉丝投票的不确定性）

#### 观测方程（Observation Equation）

```
y[t] = C * fan_vote[t] + D * judge_score[t] + v[t]
```

其中：
- `y[t]`: 观测值（综合排名/百分比）
- `C`: 观测矩阵（粉丝投票对综合得分的影响）
- `D`: 观测矩阵（评委评分对综合得分的影响）
- `v[t]`: 观测噪声（综合得分的不确定性）

### 卡尔曼滤波算法

#### 预测步骤（Predict）

1. 预测状态：
   ```
   x_pred = F * x_prev
   ```

2. 预测协方差：
   ```
   P_pred = F * P_prev * F^T + Q
   ```

#### 更新步骤（Update）

1. 计算残差：
   ```
   y = z - H * x_pred
   ```

2. 残差协方差：
   ```
   S = H * P_pred * H^T + R
   ```

3. 卡尔曼增益：
   ```
   K = P_pred * H^T * S^(-1)
   ```

4. 更新状态：
   ```
   x_new = x_pred + K * y
   ```

5. 更新协方差：
   ```
   P_new = (I - K * H) * P_pred
   ```

### 优势

1. **不确定性量化**
   - 卡尔曼滤波提供每个估计的协方差矩阵
   - 可以直接计算置信区间

2. **时间序列建模**
   - 考虑粉丝投票的时间演化
   - 利用历史信息

3. **实时更新**
   - 每周可以实时更新估计
   - 不需要重新训练整个模型

4. **理论基础**
   - 基于贝叶斯推断
   - 有严格的数学基础

## 使用方法

### 安装依赖

```bash
pip install filterpy  # 可选，提供更完整的卡尔曼滤波实现
pip install statsmodels  # 可选，用于ARIMA模型
```

如果未安装，系统会自动使用简化版实现。

### 运行状态空间模型版本

```bash
python scripts/run_stage2_ssm_estimation.py
```

### 在代码中使用

```python
from fan_vote_estimator_ssm import StateSpaceFanVoteEstimator
import pandas as pd

# 加载数据
df = pd.read_csv('2026_MCM_Problem_C_Data_processed.csv')

# 创建状态空间估计器
estimator = StateSpaceFanVoteEstimator(df)

# 估计所有周次
estimates_df = estimator.estimate_all_weeks_ssm()

# 验证模型
validation_results = estimator.validate_estimates(estimates_df)

# 查看不确定性（如果可用）
if 'uncertainty' in estimates_df.columns:
    print(f"平均不确定性: {estimates_df['uncertainty'].mean():.4f}")
```

## 模型参数

### 状态空间模型参数

- **A (自回归系数)**: 0.7
  - 表示粉丝投票有70%的惯性（与上周相关）
  - 可以调整以反映粉丝投票的稳定性

- **B (输入系数)**: 0.2
  - 表示评委评分对粉丝投票的影响
  - 可以调整以反映评委评分的影响力

- **Q (过程噪声协方差)**: 0.1
  - 较小的值表示粉丝投票相对稳定
  - 较大的值表示粉丝投票波动较大

- **R (观测噪声协方差)**: 0.5
  - 较大的值表示综合得分受多种因素影响
  - 可以调整以反映观测的不确定性

### 参数调优建议

1. **根据数据调整**
   - 分析历史数据中粉丝投票的稳定性
   - 调整A和Q参数

2. **交叉验证**
   - 使用时间序列交叉验证
   - 选择使验证准确率最高的参数

3. **贝叶斯方法**
   - 使用MCMC方法估计参数
   - 提供参数的不确定性

## 与其他方法的对比

### vs. 基础优化方法

- ✅ **优势**：提供不确定性量化、时间序列建模
- ❌ **劣势**：计算复杂度稍高

### vs. 机器学习方法

- ✅ **优势**：理论基础强、不确定性量化、实时更新
- ❌ **劣势**：需要手动设计状态空间模型

### vs. 高级ML方法（XGBoost/LightGBM）

- ✅ **优势**：不确定性量化、时间序列建模、实时更新
- ❌ **劣势**：特征工程不如ML方法灵活

## 进一步改进方向

### 1. 扩展状态空间模型

- **多变量状态**：不仅估计粉丝投票，还估计其他隐变量（如人气、争议性）
- **非线性模型**：使用扩展卡尔曼滤波（EKF）或粒子滤波（Particle Filter）

### 2. 结合其他方法

- **状态空间 + XGBoost**：使用状态空间模型提供初始值，XGBoost进行微调
- **状态空间 + MCMC**：使用MCMC方法估计状态空间模型参数

### 3. 时间序列特征

- **ARIMA模型**：捕捉粉丝投票的周期性波动
- **季节性分解**：识别季节性模式

### 4. 马尔可夫模型

- **状态转移概率**：建模粉丝投票在不同状态之间的转移
- **获胜概率**：计算在特定粉丝投票状态下的获胜概率

## 总结

状态空间模型和卡尔曼滤波为粉丝投票估计提供了一个**理论基础强、不确定性量化完善**的方法。特别适合：

1. **需要不确定性量化**的场景
2. **时间序列特性明显**的数据
3. **实时更新**的需求
4. **理论基础要求高**的论文

结合2024年C题的成功经验，这种方法应该能提供更好的估计结果和更完善的不确定性分析！
